---
title: PX4混控知识点
tags: PX4
categories: PX4
math: true
---
## **（一）混控知识点**

### **混控原理**

混控的作用是把输入指令分配到电机、舵机的执行器指令（如电调或舵机 PWM）。对于多旋翼而言，改变的为所有电机的转速。将混控逻辑从实际姿态控制器中分离出来可以大大提高复用性，保证核心控制器不需要针对机身布局特别处理。  
**简单来说，混控器和执行器就是为了将混控逻辑与实际的姿态控制器分离开来大大提高了程序的可复用性。**

### **控制组与输出组**
*控制组：* PX4系统中使用控制组（输入）和输出组。从概念上讲这两个东西非常简单：一个控制组可以是核心飞行控制器的姿态，也可以是载荷的云台。  
*输出组：* 一个输出组则是一个物理上的总线，例如：飞控上最开始的8个 PWM 舵机输出口。每一个组都有 8 个单位化（-1…+1）的指令端口，这些端口可以通过混控器进行映射和缩放。 混控器定义了这 8 个控制信号如何连接至 8 个输出口。

>**注意！：  
1.对于一个简单的飞机来说 control 0（滚转）直接与 output 0（副翼）相连接。 对于多旋翼而言事情要稍有不同：control 0（滚转）与全部四个电机相连接，并会被整合至油门指令中。  
2.对于通过AUX_OUT控制舵机来说，我们一般使用`#控制组2`来控制舵机（避免其他控制组可能会干扰到电机的工作）**

#控制组 #0 (Flight Control)  
0：roll (-1…1)  
1：pitch (-1…1)  
2：yaw (-1…1)  
3：throttle （正常范围为 0…1，变距螺旋桨和反推动力情况下范围为 -1…1）  
4：flaps (-1…1)  
5：spoilers (-1…1)  
6：airbrakes (-1…1)  
7：landing gear (-1…1)  
#控制组 #1 (Flight Control VTOL/Alternate)  
0：roll ALT (-1…1)  
1：pitch ALT (-1…1)  
2：yaw ALT (-1…1)  
3：throttle ALT （正常范围为 0…1，变距螺旋桨和反推动力情况下范围为 -1…1）  
4：保留 / aux0  
5：reserved / aux1  
6：保留 / aux2  
7：保留 / aux3  
#控制组 #2 （Gimbal）
0：gimbal roll  
1：gimbal pitch  
2: gimbal yaw  
3: gimbal shutter  
4：保留  
5：保留  
6：保留  
7：保留 (降落伞, -1…1)  
#控制组 #3 (Manual Passthrough)  
0: RC roll  
1: RC pitch  
2: RC yaw  
3: RC throttle  
4: RC mode switch  
5: RC aux1  
6: RC aux2  
7: RC aux3  
————————————————




## **（二）SD卡中自定义混控器**

对于底层的混控器，PX4的启动是从nuttx完成初始化后，运行`rcS`脚本开始的。

启动的流程大致如下：

* 系统运行rcS脚本到这里sh /etc/init.d/rc.autostart

* 在rc.autostart中根据系统参数中机型的设置参数，赋值AIRFRAME(假设这里是4001_quad_x)，然后运行. /etc/init.d/airframes/${AIRFRAME}


这里想要更改混控器需要更改px4底层源码，难度和风险较大。我们更推荐在SD卡里重定义混控器（`QGC`里也可以直接更改部分混控器参数，例如PWM_AUX_MAX）  

我们需要：  
* **在SD卡的根目录下建立一个etc的文件夹**  
* **在etc文件夹中创建mixers文件夹和config.txt文件**  
* **在mixers中创建名为mount.aux.mix文件（名称符合规范即可，在混控语法中介绍）** 


对于px4而言，如果操作系统检测到上述的config.txt存在，那么就会执行里面的内容从而可以覆盖在rc.autostart设置的一些参数，混控器也包含在内。


### **文件架构**

1. config文件负责定义使用的混控文件，以及pwm输出的上下限等参数
```
set MIXER_AUX mount         //对AUX使用混控文件mount
set PWM_AUX_OUT 12345678    //使能AUX的pwm通道1-8，对应的是px4上的FMU_PWM_OUT的1-8号通道
param set-min PWM_AUX_MIN 1000      //以下皆为更改参数
param set-max PWM_AUX_MAX 2000
param set-default PWM_AUX_DISARM 1000
set PWM_AUX_DISARMED 1000
set PWM_AUX_MIN 1000
set PWM_AUX_MAX 2000
set PWM_AUX_RATE 50           
```

2. mount.aux.mix文件负责定义混控器，对应的混控器语法在[混控文件语法](#jump)中介绍
```
# AUX1          
M: 1
O:      10000 10000      0 -10000  10000
S: 2 0  10000 10000      0 -10000  10000
# AUX2
M: 1
O:      10000 10000      0 -10000  10000
S: 2 1  10000 10000      0 -10000  10000
# AUX3
M: 1
O:      10000 10000      0 -10000  10000
S: 2 2  10000 10000      0 -10000  10000

# AUX4
M: 1
O:      10000 10000      0 -10000  10000
S: 2 3  10000 10000      0 -10000  10000
# AUX5
M: 1
O:      10000 10000      0 -10000  10000
S: 2 4  10000 10000      0 -10000  10000
# AUX6
M: 1
O:      10000 10000      0 -10000  10000
S: 2 5  10000 10000      0 -10000  10000
# AUX7
M: 1
O:      10000 10000      0 -10000  10000
S: 2 6  10000 10000      0 -10000  10000
# AUX8
M: 1
O:      10000 10000      0 -10000  10000
S: 2 7  10000 10000      0 -10000  10000
```

### 混控语法
**混控脚本的语法**  
如果混控器是用在主通道输出的，则必须命名为`XXXX.main.mix`，如果是用于辅助通道输出的，则必须命名为`XXXX.aux.mix`．  
<span id="jump">**混空文件语法** </span>  
这里我们只介绍我们用到的**累加混空**   
累加混控也成为简单混控（Simple），混控器将零或更多的控制输入合并到单个执行器输出中。输入被缩放，混控函数在应用输出缩放器之前对结果求和。格式如下：
```
M: <输入控制量个数>
O: <负缩放> <正缩放> <偏移值> <下限> <上限> <横向时间（可选）>
```
第一行M: <输入控制量个数>代表有个几输入来源。  
第二行O: 缩放值按10000的因数缩放；偏移值也按10000的因数偏移。<横向时间>用于执行器，如果执行器动作变化过快，可能会损坏执行器。例如，20000的<横向时间>值将限制执行器的变化率，使其从<下限>到<上限>至少需要2秒。
```
S: <控制输入组> <索引值> <负缩放> <正缩放> <偏移值> <下限> <上限>
```
S:表示具体的输入来源，与第一行M: <输入控制量个数>对应，有几个输入控制量，就有几个S:．如果<输入控制量个数>为零，混控器将输出一个受<下限>和<上限>约束的固定的<偏移值>。<控制输入组>值标识混控器将从中读取的控制组，<索引值>值标识该组内的偏移量。例如控制输入组0是载具姿态控制组，<索引值>0到3分别是横摇、俯仰、偏航和推力。
典型示例：
```
M: 2
O:      10000  10000      0 -10000  10000
S: 0 0  -6000  -6000      0 -10000  10000
S: 0 1   6500   6500      0 -10000  10000
```
有两个控制输入组，表示混控器将接收到两个输入  
正负缩放均为1，偏移量为零，和输出范围-1到1。如果要反转PWM信号，必须更改输出比例的符号：O: -10000 -10000 0 -10000 10000
如果该行指定了默认的缩放比例O: 10000 10000 0 -10000 10000，则可以（也应该）完全忽略该行。  
第三行S：表示第一个控制输入：它接受控制组#0（飞行控制）和第一个输入（滚转）的输入。它缩放滚动控制输入*0.6，并恢复符号（-0.6以缩放单位变为-6000）。它不应用偏移（0）并输出到全量程（-1…+1）



## **（三）上位机驱动**

上位机的驱动比较简单，只需要向`/mavros/actuator_control`发布内容即可驱动舵机，其中group_mix参数填写控制组，数组controls填写映射量（通常取值为-1~1）

**注意驱动必须在`OFFBOARD`模式下才能成功，即需要在飞行途中或者一直使用代码切入offboard模式**

以下给出关键示例代码

```c++
	//仅做演示
	ros::Publisher claw_pub_mix = nh.advertise<mavros_msgs::ActuatorControl>("/mavros/actuator_control", 1);
	mavros_msgs::ActuatorControl claw_control_mix;
	claw_control_mix.group_mix = 2;
    //取值一般为-1~1
	for (int i = 0; i < 8; ++i) {
		claw_control_mix.controls[i] = -1;
	}
	claw_pub_mix.publish(claw_control_mix);
```

## **总结**
日常对混控器的使用一般都比较简单，使用SD卡改写混控文件，在config.txt中设置好pwm输出的上下限，以及disarm值。XXX.aux.min文件一般只使用一组通道来映射，我们只需要在需要pwm输出时往`/mavros/actuator_control`话题发布消息，注意好各个通道的对应关系即可。
